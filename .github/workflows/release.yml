name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            meson \
            gjs \
            libgtk-4-dev \
            libadwaita-1-dev \
            libglib2.0-dev \
            librsvg2-bin \
            debhelper \
            devscripts \
            build-essential \
            nodejs \
            npm
      
      - name: Install npm dependencies
        run: npm install
      
      - name: Build TypeScript
        run: npm run build
      
      - name: Check build output
        run: |
          echo "=== Node.js version ==="
          node --version
          npm --version
          which node
          which npm
          echo "=== Builddir contents ==="
          ls -lah builddir/
          echo "=== Debian directory ==="
          ls -lah debian/
      
      - name: Build Debian package
        run: |
          echo "=== Building Debian package ==="
          dpkg-buildpackage -us -uc -b -d
          echo "=== Checking parent directory ==="
          ls -lah ../ | grep obision
      
      - name: Move .deb to builddir
        run: |
          mkdir -p builddir
          mv ../obision-app-system_*.deb builddir/obision-app-system.deb
          mv ../obision-app-system_*.buildinfo builddir/ 2>/dev/null || true
          mv ../obision-app-system_*.changes builddir/ 2>/dev/null || true
      
      - name: Verify .deb file
        run: |
          ls -lh builddir/
          if [ ! -f builddir/obision-app-system.deb ]; then
            echo "Error: .deb file not found!"
            exit 1
          fi
          echo "✅ .deb file created successfully"
      
      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: builddir/obision-app-system.deb
          generate_release_notes: true
          name: Release ${{ steps.get_version.outputs.VERSION }}
          draft: false
          prerelease: false
          fail_on_unmatched_files: true
      
      - name: Upload to obision-packages repository
        env:
          DEPLOY_KEY: ${{ secrets.OBISION_PACKAGES_DEPLOY_KEY }}
        run: |
          # Extract version from tag
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "Version: $VERSION"
          
          # Configure git
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # Setup SSH key for obision-packages repo
          mkdir -p ~/.ssh
          echo "$DEPLOY_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan github.com >> ~/.ssh/known_hosts
          
          # Clone obision-packages repository
          cd ..
          git clone git@github.com:nirlob/obision-packages.git
          cd obision-packages
          
          # Create debs directory if it doesn't exist
          mkdir -p debs
          
          # Remove old versions of the package
          rm -f debs/obision-app-system_*.deb
          
          # Copy the .deb file with versioned name
          cp ../obision-app-system/builddir/obision-app-system.deb \
             debs/obision-app-system_${VERSION}_all.deb
          
          # Regenerate Packages file
          dpkg-scanpackages --multiversion debs > Packages
          gzip -k -f Packages
          
          # Generate Release file
          cat > Release << EOF
          Origin: Obision
          Label: Obision Packages
          Suite: stable
          Codename: stable
          Architectures: all amd64 arm64
          Components: main
          Description: Obision APT Repository
          Date: $(date -Ru)
          EOF
          
          # Add checksums to Release file
          echo "MD5Sum:" >> Release
          for file in Packages Packages.gz; do
            echo " $(md5sum $file | cut -d' ' -f1) $(wc -c < $file) $file" >> Release
          done
          
          echo "SHA1:" >> Release
          for file in Packages Packages.gz; do
            echo " $(sha1sum $file | cut -d' ' -f1) $(wc -c < $file) $file" >> Release
          done
          
          echo "SHA256:" >> Release
          for file in Packages Packages.gz; do
            echo " $(sha256sum $file | cut -d' ' -f1) $(wc -c < $file) $file" >> Release
          done
          
          # Commit and push (including deletions)
          git add -A debs/
          git add Packages Packages.gz Release
          git commit -m "Update obision-app-system to version $VERSION"
          git push origin master
          
          echo "✅ Package uploaded to obision-packages repository"
